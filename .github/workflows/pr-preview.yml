name: Generate Documentation Preview

# Manually deploy PR documentation previews to GitHub Pages
# Can be triggered from the Actions tab to preview docs from any PR

on:
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'PR number to preview (leave empty for "CleanAll")'
                required: false
                type: string
            action_type:
                description: 'Action to perform'
                required: true
                type: choice
                options:
                    - Generate
                    - Clean
                    - CleanAll
                default: Generate

# SECURITY: Minimal permissions required
# - contents:write is needed to push to gh-pages branch
# - pull-requests:write is needed to comment the preview URL
permissions:
    contents: write
    pull-requests: write

concurrency:
    group: ${{ inputs.action_type == 'CleanAll' && 'pr-preview-clean-all' || format('pr-preview-{0}', inputs.pr_number) }}
    cancel-in-progress: true

jobs:
    deploy-preview:
        name: Deploy Documentation Preview
        runs-on: ubuntu-latest
        if: ${{ inputs.action_type != 'CleanAll' }}

        steps:
            - name: ğŸ”¢ Validate PR Number
              if: ${{ inputs.action_type != 'CleanAll' }}
              run: |
                  if [ -z "${{ inputs.pr_number }}" ]; then
                    echo "Error: pr_number input is required for action_type '${{ inputs.action_type }}'."
                    exit 1
                  fi

            - name: ğŸ” Get PR Details
              id: pr
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumberInput = process.env.PR_NUMBER_INPUT;
                      const pull_number = prNumberInput ? Number(prNumberInput) : context.issue.number;
                      const pr = await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number
                      });
                      core.setOutput('ref', pr.data.head.sha);
                      core.setOutput('head_ref', pr.data.head.ref);
                      core.setOutput('pr_number', String(pr.data.number));
                      return pr.data;
              env:
                  PR_NUMBER_INPUT: ${{ inputs.pr_number }}

            - name: ğŸ“¥ Checkout PR
              uses: actions/checkout@v4
              with:
                  ref: ${{ steps.pr.outputs.ref }}
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: âš™ï¸ Resolve Action
              id: resolve
              run: |
                  if [ "${{ inputs.action_type }}" = "Generate" ]; then
                    echo "action=deploy" >> $GITHUB_OUTPUT
                  elif [ "${{ inputs.action_type }}" = "Clean" ]; then
                    echo "action=remove" >> $GITHUB_OUTPUT
                  else
                    echo "action=none" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸš€ Deploy/Clean Preview
              id: preview
              uses: rossjrw/pr-preview-action@v1
              with:
                  source-dir: docs/
                  preview-branch: gh-pages
                  umbrella-dir: pr-preview
                  action: ${{ steps.resolve.outputs.action }}
                  comment: false
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ’¬ Comment Preview URL
              if: ${{ steps.resolve.outputs.action == 'deploy' }}
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  number: ${{ steps.pr.outputs.pr_number }}
                  header: pr-preview
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  message: |
                      ## ğŸ“š Documentation Preview

                      Your documentation preview has been manually deployed and will be available shortly at:

                      **ğŸ”— ${{ steps.preview.outputs.preview-url }}**

                      To update the preview, trigger this workflow again with the same PR number.

                      ---
                      <sub>Preview deployed to branch `gh-pages` at ${{ steps.preview.outputs.action-start-time }} by @${{ github.actor }}</sub>

            - name: ğŸ—‘ï¸ Comment Preview Cleaned
              if: ${{ steps.resolve.outputs.action == 'remove' }}
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  number: ${{ steps.pr.outputs.pr_number }}
                  header: pr-preview
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  message: |
                      ## ğŸ“š Documentation Preview

                      Preview has been manually cleaned.

                      ---
                      <sub>Cleaned at ${{ steps.preview.outputs.action-start-time }} by @${{ github.actor }}</sub>

    clean-all-previews:
        name: Clean All Previews
        runs-on: ubuntu-latest
        if: ${{ inputs.action_type == 'CleanAll' }}

        steps:
            - name: ğŸ“ Checkout gh-pages
              uses: actions/checkout@v4
              with:
                  ref: gh-pages
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ§¹ Remove All Previews
              run: |
                  if [ -d "pr-preview" ]; then
                    echo "Removing all preview deployments..."
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git rm -rf pr-preview
                    git commit -m "Clean all PR previews (triggered by @${{ github.actor }})"
                    git push
                    echo "âœ… All previews removed"
                  else
                    echo "â„¹ï¸ No pr-preview directory found, nothing to clean"
                  fi
