name: Preview Documentation

# Manually deploy PR documentation previews to GitHub Pages
# Can be triggered from the Actions tab to preview docs from any PR

on:
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'PR number to preview (leave empty for "clean-all")'
                required: false
                type: string
            action_type:
                description: 'Action to perform'
                required: true
                type: choice
                options:
                    - deploy
                    - remove
                    - clean-all
                default: deploy

# SECURITY: Minimal permissions required
# - contents:write is needed to push to gh-pages branch
# - pull-requests:write is needed to comment the preview URL
permissions:
    contents: write
    pull-requests: write

concurrency:
    group: ${{ inputs.action_type == 'clean-all' && 'pr-preview-clean-all' || format('pr-preview-{0}', inputs.pr_number) }}
    cancel-in-progress: true

jobs:
    deploy-preview:
        name: Deploy Documentation Preview
        runs-on: ubuntu-latest
        if: inputs.action_type != 'clean-all'

        steps:
            # Get PR details to access the head SHA and branch
            - name: Get PR Details
              id: pr
              uses: actions/github-script@v7
              with:
                  script: |
                      const pr = await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: ${{ inputs.pr_number }}
                      });
                      core.setOutput('ref', pr.data.head.sha);
                      core.setOutput('head_ref', pr.data.head.ref);
                      return pr.data;

            # Checkout the PR branch
            - name: Checkout PR
              uses: actions/checkout@v4
              with:
                  ref: ${{ steps.pr.outputs.ref }}

            # Deploy or remove the preview based on manual input
            - name: Deploy/Remove Preview
              id: preview
              uses: rossjrw/pr-preview-action@v1
              with:
                  source-dir: docs/
                  preview-branch: gh-pages
                  umbrella-dir: pr-preview
                  action: ${{ inputs.action_type }}
                  comment: false

            # Post custom comment for deployments
            - name: Comment Preview URL
              uses: marocchino/sticky-pull-request-comment@v2
              if: inputs.action_type == 'deploy'
              with:
                  number: ${{ inputs.pr_number }}
                  header: pr-preview
                  message: |
                      ## üìö Documentation Preview

                      Your documentation preview has been manually deployed and will be available shortly at:

                      **üîó ${{ steps.preview.outputs.preview-url }}**

                      To update the preview, trigger this workflow again with the same PR number.

                      ---
                      <sub>Preview deployed to branch `gh-pages` at ${{ steps.preview.outputs.action-start-time }} by @${{ github.actor }}</sub>

            # Post comment when preview is removed
            - name: Comment Preview Removed
              uses: marocchino/sticky-pull-request-comment@v2
              if: inputs.action_type == 'remove'
              with:
                  number: ${{ inputs.pr_number }}
                  header: pr-preview
                  message: |
                      ## üìö Documentation Preview

                      Preview has been manually removed.

                      ---
                      <sub>Removed at ${{ steps.preview.outputs.action-start-time }} by @${{ github.actor }}</sub>

    clean-all-previews:
        name: Clean All Previews
        runs-on: ubuntu-latest
        if: inputs.action_type == 'clean-all'

        steps:
            # Checkout the gh-pages branch
            - name: Checkout gh-pages
              uses: actions/checkout@v4
              with:
                  ref: gh-pages

            # Remove the entire pr-preview directory
            - name: Remove All Previews
              run: |
                  if [ -d "pr-preview" ]; then
                    echo "Removing all preview deployments..."
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git rm -rf pr-preview
                    git commit -m "Clean all PR previews (triggered by @${{ github.actor }})"
                    git push
                    echo "‚úÖ All previews removed"
                  else
                    echo "‚ÑπÔ∏è No pr-preview directory found, nothing to clean"
                  fi
